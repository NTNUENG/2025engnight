<!DOCTYPE html>
<html lang="zh-tw">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>實體週購票存根系統｜國立臺灣師範大學 117 級英語學系之 2025 英語之夜</title>
    <meta name="description" content="實體週購票存根系統僅國立臺灣師範大學 117 級英語學系之 2025 英語之夜工人（不含大三大四生）可使用之。">
    <link rel="icon" type="image/x-icon" href="../image/favicon.ico">
    <link rel="stylesheet" crossorigin="anonymous" href="https://cdn.jsdelivr.net/gh/Zutek3134/zutek3134.github.io@main/stylesheets/style.css" />
    <link rel="stylesheet" crossorigin="anonymous" href="https://cdn.jsdelivr.net/gh/Zutek3134/zutek3134.github.io@main/stylesheets/mandarinSupport.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.js" crossorigin="anonymous"></script>
    <style>
        :root {
            --bg: #271d1d;
            --bg-rgb: 255, 248, 247;
            --bg-dark: #221919;
            --color: #f0dede;
            --title-color: #d7c1c1;
            --card-bg: rgb(50, 40, 39);
            --card-bg-rgb: 50, 40, 39;
            --border: #a08c8c;
            --border-half: #a08c8c80;
            --primary: #ffb3b2;
            --secondary: #e6bdbc;
            --teritary: #e5c18d;
            --nav-height: 0;
        }

        fieldset {
            border: none;
            margin: 0;
            padding: 0;
        }

        main {
            min-height: 100dvh;
        }

        input {
            color: var(--color);
        }

        input:invalid {
            border-color: var(--danger);
        }

        form input {
            padding: var(--gap-half);
            width: 100%;
            font-family: var(--mono-font);
        }

        form {
            margin: auto;
            max-width: max(30dvw, 20em);
        }

        .btn {
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, border 0.2s ease-in-out, opacity 0.2s ease-in-out;
        }

        .hanLat:empty {
            display: none;
        }

        .loader {
            border: 16px solid var(--bg-dark);
            border-top: 16px solid var(--primary);
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #csv-table {
            font-family: var(--mono-font);
        }

        .curser-pointer {
            cursor: pointer;
        }

        .sort-indicator {
            margin-right: 0.5em;
        }
    </style>
</head>

<body>
    <main>
        <div class="gradient"></div>
        <div class="container" style="min-height: 100dvh;">
            <h1 class="text-centre"><span class="hanLat hl-r">2025</span>英語之夜實體週購票存根系統</h1>
            <section class="mar-b-2">
                <div class="alert alert-info" style="--alert-colour: 255, 179, 178">
                    <div class="alert-icon"></div>
                    <p class="alert-message">本系統僅允許本次活動之大一、二工人進行填寫。</p>
                </div>
            </section>
            <div id="loading">
                <section style="display: flex; flex-direction: column; min-height: 45dvh;">
                    <div style="margin: auto;">
                        <div class="loader"></div>
                    </div>
                    <p class="text-centre" style="padding: 0 1em">If I am still spinning then blame NTNU Internet.</p>
                </section>
            </div>
            <section id="form" class="display-none">
                <form action="https://docs.google.com/forms/d/e/1FAIpQLSe6_OSj_EGGv4_DccWhlCKkjEkhRgjjxygHUwt4xdnDWLLG4Q/formResponse" target="_self" id="bootstrapForm" method="POST">
                    <!-- Field type: "short" id: "1532724054" -->
                    <fieldset>
                        <p class="smolTitle mar-b-0">工人學號</p>
                        <div class="form-group">
                            <input id="1771806550" type="text" name="entry.1771806550" pattern="41[2-3]21[1-2][0-9]{2}L" required>
                        </div>
                    </fieldset>

                    <!-- Field type: "short" id: "957020910" -->
                    <fieldset class="display-none">
                        <p class="smolTitle mar-b-0">工人華文姓名</p>
                        <div class="form-group">
                            <input id="973015413" type="text" name="entry.973015413" readonly>
                        </div>
                    </fieldset>

                    <!-- Field type: "short" id: "9576480" -->
                    <fieldset>
                        <p class="smolTitle mar-b-0">顧客末三碼</p>
                        <div class="form-group">
                            <input id="364123990" type="text" name="entry.364123990" pattern="[0-9][0-9][0-9]" required>
                        </div>
                    </fieldset>

                    <!-- Field type: "short" id: "2001629101" -->
                    <fieldset>
                        <p class="smolTitle mar-b-0">購買張數</p>
                        <div class="form-group">
                            <input id="1039004342" type="number" name="entry.1039004342" min="1" required>
                        </div>
                    </fieldset>

                    <!-- Field type: "short" id: "1028669504" -->
                    <fieldset style="cursor: not-allowed;">
                        <p class="smolTitle mar-b-0">總金額</p>
                        <div class="form-group">
                            <input id="1509187343" type="number" name="entry.1509187343" style="pointer-events: none;" readonly>
                        </div>
                    </fieldset>

                    <input type="hidden" name="fvv" value="1">
                    <input type="hidden" name="fbzx" value="-6532318948201223492">
                    <input type="hidden" name="pageHistory" value="0">

                    <button id="submitBtn" class="disabled btn btn-wide btn-fill btn-success" style="margin-top: 2em" type="submit" disabled>提交</button>
                </form>
            </section>

        </div>
        <div id="divLog" class="container">
            <h2 class="mar-t-0">存根系統後臺</h2>
            <p>為節省傳輸資源，後臺不採即時更新，請自行重新整理。惟礙於瀏覽器快取等影響，恐無法立即見效。若多次點擊仍無果，請嘗試<a class="inlineLink" onclick="location.reload()">【點擊這裡】</a>。</p>
            <div class="table-container mar-t-1">
                <table id="csv-table"></table>
            </div>
            <button id="buttonRefresh" class="btn btn-fill btn-secondary display-none" disabled>重新整理</button>
        </div>
    </main>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.2.2/jquery.form.min.js" integrity="sha256-2Pjr1OlpZMY6qesJM68t2v39t+lMLvxwpa8QlRjJroA=" crossorigin="anonymous"></script>
    <script>
        $('#bootstrapForm').submit(function (event) {
            event.preventDefault()
            var extraData = {}
            $('#bootstrapForm').ajaxSubmit({
                data: extraData,
                dataType: 'jsonp',
                error: function () {
                    alert('提交成功');
                    successfullySent();
                }
            })
        })

        function successfullySent() {
            const inputIds = ['364123990', '1039004342', '1509187343'];

            $.each(inputIds, function (_, id) {
                $('#' + id).val(null);
            });
        }

        function finishLoading(workersData) {
            const inputId = document.getElementById('1771806550');
            const inputName = document.getElementById('973015413');
            const inputTelephone = document.getElementById('364123990');
            const inputAmount = document.getElementById('1039004342');
            const inputPrice = document.getElementById('1509187343');
            const buttonSubmit = document.getElementById('submitBtn');

            let validId = false;
            let validTelephone = false;
            let validAmount = false;

            inputId.addEventListener('input', function () {
                const id = inputId.value.toUpperCase();
                inputId.value = id;

                canSubmit();
            });

            inputTelephone.addEventListener('input', function () {
                canSubmit();
            });

            inputAmount.addEventListener('input', function () {
                const amount = inputAmount.value;

                if (amount == 1) {
                    inputPrice.value = 100;
                }
                else if (amount == 2) {
                    inputPrice.value = 190;
                }
                else if (amount >= 3) {
                    inputPrice.value = amount * 100 - 30;
                }
                else {
                    inputPrice.value = '';
                }

                canSubmit();
            });

            function canSubmit() {
                validId = workersData.hasOwnProperty(inputId.value);
                if (validId) {
                    inputName.value = workersData[inputId.value].name;
                }
                validTelephone = inputTelephone.checkValidity();
                validAmount = inputAmount.checkValidity();

                const validForm = validId && validTelephone && validAmount;
                buttonSubmit.classList.toggle('disabled', !validForm);
                buttonSubmit.disabled = !validForm;
            }
        }

        async function loadJson(name) {
            const response = await fetch(`../includes/${name}.json`);
            const data = await response.json();
            return data;
        }

        async function initializePage() {
            try {
                document.getElementById('loading').remove();
                document.getElementById('form').classList.remove('display-none');
                const workersData = await loadJson('workers_data');
                finishLoading(workersData);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        window.addEventListener('load', initializePage);
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        buttonRefresh = document.getElementById('buttonRefresh');
        buttonRefresh.addEventListener("click", () => refresh(true));

        const table = document.getElementById('csv-table');

        function refresh(scroll) {
            buttonRefresh.classList.add('display-none');
            buttonRefresh.disabled = true;

            table.innerHTML = '';

            const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSMImGmL_HmIkrf7PBz07en26YHTPDzNffv9u1K-XBMPCav2rK4xkYvaXJhJCZHXaqMhcwfB9QATETE/pub?gid=583917275&single=true&output=csv";

            fetch(csvUrl)
                .then(response => response.text())
                .then(csvContent => {
                    Papa.parse(csvContent, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function (results) {
                            generateTable(results.data);
                        },
                        error: function (error) {
                            console.error("Error parsing CSV:", error.message);
                        }
                    });
                })
                .catch(error => {
                    console.error("Error fetching CSV file:", error.message);
                });

            function generateTable(data) {
                if (data.length === 0) {
                    table.innerHTML = '<tr><td colspan="100%" class="text-centre">目前尚無資料</td></tr>';

                    buttonRefresh.classList.remove('display-none');
                    buttonRefresh.disabled = false;
                    return;
                }

                const headers = Object.keys(data[0]);
                let headerRow = document.createElement('tr');
                headers.forEach(function (header) {
                    if (header === "工人學號")
                        return;

                    let th = document.createElement('th');

                    if (header === "時間戳記") {
                        let indicator = document.createElement('span');
                        indicator.classList.add('sort-indicator');
                        th.append(indicator);

                        th.innerHTML += "日時分秒";
                        th.classList.add('curser-pointer');
                        th.addEventListener("click", sortTable);
                    } else {
                        if (["總金額", "購買張數"].includes(header)) {
                            th.classList.add('text-right');
                        }

                        th.textContent = header;
                    }

                    headerRow.appendChild(th);
                });
                table.appendChild(headerRow);

                data.forEach(function (row) {
                    let tr = document.createElement('tr');
                    headers.forEach(function (header) {
                        let td = document.createElement('td');
                        let cellValue = row[header] || '';

                        if (header === "工人學號") {
                            return;
                        }
                        else if (["總金額", "購買張數"].includes(header)) {
                            td.textContent = cellValue;
                            td.classList.add('text-right');
                        }
                        else if (header === "時間戳記") {
                            td.textContent = formatDate(cellValue);
                        }
                        else {
                            td.textContent = cellValue;
                        }

                        tr.appendChild(td);
                    });
                    table.appendChild(tr);
                });

                const curOrder = table.getAttribute("data-sort-order");
                table.setAttribute("data-sort-order", curOrder === "descending" ? "ascending" : "descending");

                sortTable();

                buttonRefresh.classList.remove('display-none');
                buttonRefresh.disabled = false;

                if (scroll)
                    document.getElementById('divLog').scrollIntoView({ behavior: "smooth" });
            }

            function formatDate(dateString) {
                const regex = /(\d{4})\/(\d{1,2})\/(\d{1,2})\s(上午|下午)\s(\d{1,2}):(\d{2}):(\d{2})/;
                const match = dateString.match(regex);

                if (match) {
                    const year = match[1] - 1911;
                    const month = match[2];
                    const day = match[3].padStart(2, '0');
                    let hours = parseInt(match[5], 10);
                    const minutes = match[6];
                    const seconds = match[7];

                    if (match[4] === '下午' && hours < 12) {
                        hours += 12;
                    } else if (match[4] === '上午' && hours === 12) {
                        hours = 0;
                    }

                    return `${day} ${hours.toString().padStart(2, '0')}:${minutes}:${seconds}`;
                }

                return dateString;
            }
        }

        refresh(false);

        function sortTable() {
            const rows = Array.from(table.rows).slice(1);
            const isAscending = table.getAttribute("data-sort-order") === "ascending";
            const newOrder = isAscending ? "descending" : "ascending";
            table.setAttribute("data-sort-order", newOrder);

            rows.sort((rowA, rowB) => {
                const cellA = rowA.cells[0].innerText;
                const cellB = rowB.cells[0].innerText;

                const comparison = isNaN(cellA) || isNaN(cellB)
                    ? cellA.localeCompare(cellB)
                    : Number(cellA) - Number(cellB);

                return !isAscending ? comparison : -comparison;
            });

            rows.forEach(row => table.appendChild(row));

            const headers = table.querySelectorAll("th");

            headers.forEach((header, index) => {
                const indicator = header.querySelector(".sort-indicator");
                if (indicator) {
                    indicator.textContent = '';
                }
            });

            const sortedHeader = headers[0];
            const indicator = sortedHeader.querySelector(".sort-indicator");

            if (newOrder === "ascending") {
                indicator.textContent = '▲';
            } else {
                indicator.textContent = '▼';
            }
        }
    </script>
</body>

</html>